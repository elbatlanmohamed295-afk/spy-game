<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ù†ÙŠ Ø£Ø¯Ù…ÙŠÙ† ÙˆØ¨Ø±Øµ ğŸ¦ PRO</title>
    <link rel="icon" href="/logo.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
        :root { --gold: #ffd700; --dark: #121212; --card: #1e1e1e; --spy: #ff4757; --green: #2ecc71; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Cairo', sans-serif; background: var(--dark); color: #fff; margin: 0; padding: 15px; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        
        .container { width: 100%; max-width: 500px; background: var(--card); padding: 20px; border-radius: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.7); border: 1px solid #333; }
        h1 { color: var(--gold); text-align: center; margin-bottom: 20px; text-shadow: 0 0 15px rgba(255, 215, 0, 0.2); }

        /* Ø£Ø²Ø±Ø§Ø± ÙˆÙ…Ø¯Ø§Ø®Ù„ */
        input, select, button { width: 100%; padding: 15px; margin-bottom: 12px; border-radius: 12px; border: 2px solid #333; font-family: 'Cairo'; font-size: 16px; transition: 0.3s; }
        input, select { background: #2c2c2c; color: #fff; }
        button { font-weight: 900; cursor: pointer; border: none; }
        button:active { transform: scale(0.96); }
        .btn-join { background: var(--gold); color: #000; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3); }
        .btn-start { background: var(--green); color: #fff; }
        .btn-reveal { background: var(--spy); color: #fff; }

        /* Ø´Ø¨ÙƒØ© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ (Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡) */
        .friends-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .friend-card { 
            background: #2a2a2a; border-radius: 15px; padding: 10px 5px; 
            text-align: center; cursor: pointer; border: 2px solid transparent; transition: 0.2s;
        }
        .friend-card img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-bottom: 5px; border: 2px solid #555; }
        .friend-card span { display: block; font-size: 11px; line-height: 1.3; font-weight: bold; color: #ddd; }
        
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± */
        .friend-card.selected { border-color: var(--gold); background: rgba(255, 215, 0, 0.1); transform: translateY(-3px); }
        .friend-card.selected img { border-color: var(--gold); }
        .friend-card.selected span { color: var(--gold); }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„ÙˆØ¨ÙŠ */
        .player-item { display: flex; align-items: center; gap: 10px; background: #2a2a2a; padding: 8px 12px; border-radius: 10px; margin-bottom: 8px; border: 1px solid #333; }
        .player-img-sm { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 1px solid var(--gold); }

        /* ÙƒØ§Ø±Øª Ø§Ù„Ù„Ø¹Ø¨ */
        .game-card { background: linear-gradient(135deg, #fff, #eee); color: #000; padding: 30px; border-radius: 20px; margin: 20px 0; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.5); animation: popUp 0.5s; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© */
        .result-box { text-align: center; animation: fadeIn 0.5s; }
        .spy-avatar { width: 120px; height: 120px; border-radius: 50%; border: 5px solid var(--spy); margin: 15px auto; display: block; object-fit: cover; }
        
        .hidden { display: none !important; }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255,215,0,0.9); color: #000; padding: 10px 20px; border-radius: 20px; display: none; z-index: 100; font-weight: bold; width: 90%; text-align: center;}
    </style>
</head>
<body>

    <div id="toast"></div>
    <div class="container">
        <h1>ğŸ¦ Ø¨Ù†ÙŠ Ø£Ø¯Ù…ÙŠÙ† ÙˆØ¨Ø±Øµ</h1>

        <div id="loginArea">
            <h3 style="text-align:center; color:#888; margin-top:0;">Ù…ÙŠÙ† Ø§Ù„Ù„ÙŠ Ø¨ÙŠÙ„Ø¹Ø¨ØŸ</h3>
            
            <div class="friends-grid" id="friendsGrid">
                </div>

            <div id="guestInput" class="hidden">
                <input type="text" id="customName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙŠØ§ Ø¶ÙŠÙ...">
            </div>

            <input type="number" id="room" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©" value="777" style="text-align:center; letter-spacing: 2px; font-weight:bold;">
            <button class="btn-join" onclick="join()">ÙŠØ§Ù„Ø§ Ø¨ÙŠÙ†Ø§ ğŸš€</button>
        </div>

        <div id="lobby" class="hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span>Ø§Ù„ØºØ±ÙØ©: <b id="rId" style="color:var(--gold)"></b></span>
                <span>Ø§Ù„Ø¹Ø¯Ø¯: <b id="count">0</b></span>
            </div>
            <select id="cat">
                <option>Ø£Ù…Ø§ÙƒÙ† ğŸŒ</option><option>Ø£ÙƒÙ„Ø§Øª ğŸ¥˜</option><option>Ù…Ø´Ø§Ù‡ÙŠØ± ğŸŒŸ</option>
                <option>Ø£ÙÙ„Ø§Ù… ğŸ¬</option><option>ÙˆØ¸Ø§Ø¦Ù ğŸ‘·</option>
            </select>
            <div id="pList" style="margin:15px 0;"></div>
            <button class="btn-start" onclick="start()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙŠÙ… ğŸ”¥</button>
        </div>

        <div id="gameArea" class="hidden">
            <div class="game-card">
                <h3 id="role" style="margin:0; opacity:0.7;"></h3>
                <h1 id="item" style="font-size:2.5em; margin:10px 0;"></h1>
            </div>
            <button id="revBtn" class="btn-reveal" onclick="vote()">ğŸš¨ ÙƒØ´Ù Ø§Ù„Ø¬Ø§Ø³ÙˆØ³</button>
            <p id="vStat" class="hidden" style="text-align:center; margin:10px 0;">Ø§Ù„Ø£ØµÙˆØ§Øª: <span id="vCount" style="color:var(--gold)">0</span></p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px;">
                <button onclick="shout('Ø´Ø§ÙƒÙƒ ÙÙŠÙƒ! ğŸ‘€')" style="background:#333; color:var(--gold); padding:10px; font-size:12px;">Ø´Ø§ÙƒÙƒ ÙÙŠÙƒ! ğŸ‘€</button>
                <button onclick="shout('ÙˆØ§Ù„Ù„Ù‡ Ø¨Ø±ÙŠØ¡ ğŸ˜‡')" style="background:#333; color:var(--gold); padding:10px; font-size:12px;">ÙˆØ§Ù„Ù„Ù‡ Ø¨Ø±ÙŠØ¡ ğŸ˜‡</button>
                <button onclick="shout('Ø§Ù„Ø¨Ø±Øµ Ø¨Ø§Ù† ğŸ˜‚')" style="background:#333; color:var(--gold); padding:10px; font-size:12px;">Ø§Ù„Ø¨Ø±Øµ Ø¨Ø§Ù† ğŸ˜‚</button>
                <button onclick="shout('ÙˆØ´Ùƒ Ù…Ø´ Ù…Ø±ÙŠØ­ ğŸ¤¨')" style="background:#333; color:var(--gold); padding:10px; font-size:12px;">ÙˆØ´Ùƒ Ù…Ø´ Ù…Ø±ÙŠØ­ ğŸ¤¨</button>
            </div>
        </div>

        <div id="resultArea" class="hidden">
            <div class="result-box">
                <h2 style="color:var(--spy);">Ù‚ÙØ´Ù†Ø§ Ø§Ù„Ø¨Ø±Øµ! ğŸ¦</h2>
                <img id="spyImg" class="spy-avatar" src="">
                <h2 id="spyName"></h2>
                <div style="background:rgba(255,71,87,0.1); border:1px solid var(--spy); padding:15px; border-radius:15px; margin:15px 0;">
                    <b>â˜ ï¸ Ø§Ù„Ø¹Ù‚Ø§Ø¨:</b> <span id="pun"></span>
                </div>
                <button class="btn-join" onclick="reset()">ğŸ”„ Ø¯ÙˆØ± ÙƒÙ…Ø§Ù†</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        
        // 1. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù„Ø© (ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª Ø¨Ø§Ù„Ø¶Ø¨Ø·)
        const friends = [
            { name: "Ù…Ø­Ù…Ø¯ Ø±Ù…Ø¶Ø§Ù†", img: "1.jpeg" },
            { name: "Ø£Ø­Ù…Ø¯ Ø­Ù…Ø¯ÙŠ", img: "2.jpeg" },
            { name: "Ø£Ù…ÙŠÙ† Ù…Ø­Ù…Ø¯", img: "3.jpeg" },
            { name: "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ù…Ø­Ù…ÙˆØ¯", img: "4.jpeg" },
            { name: "Ø£Ø­Ù…Ø¯ Ø§Ù„Ø¯Ù‡Ø´ÙˆØ±ÙŠ", img: "5.jpeg" },
            { name: "ÙŠÙˆØ³Ù Ù…Ø­Ù…Ø¯", img: "6.jpeg" },
            { name: "Ø¹Ø¨Ø¯ Ø§Ù„Ù‚Ø§Ø¯Ø± Ù…Ø­Ù…ÙˆØ¯", img: "7.jpeg" },
            { name: "Ø¶ÙŠÙ Ø¬Ø¯ÙŠØ¯", img: "logo.png", isGuest: true }
        ];

        let selectedUser = null;
        let myName = '';
        let myRoom = '';

        // ØªÙˆÙ„ÙŠØ¯ Ø´Ø¨ÙƒØ© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        const grid = document.getElementById('friendsGrid');
        friends.forEach(friend => {
            let div = document.createElement('div');
            div.className = 'friend-card';
            div.innerHTML = `<img src="${friend.img}"><span>${friend.name}</span>`;
            div.onclick = () => selectFriend(div, friend);
            grid.appendChild(div);
        });

        function selectFriend(element, friendData) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
            document.querySelectorAll('.friend-card').forEach(el => el.classList.remove('selected'));
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            element.classList.add('selected');
            selectedUser = friendData;
            
            // Ù„Ùˆ Ø¶ÙŠÙØŒ Ø£Ø¸Ù‡Ø± Ø®Ø§Ù†Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
            if(friendData.isGuest) {
                document.getElementById('guestInput').classList.remove('hidden');
            } else {
                document.getElementById('guestInput').classList.add('hidden');
            }
        }

        function join() {
            if(!selectedUser) { showToast("Ø§Ø®ØªØ§Ø± Ø§Ø³Ù…Ùƒ Ø§Ù„Ø£ÙˆÙ„ ÙŠØ§ Ù†Ø¬Ù…!"); return; }
            
            myRoom = document.getElementById('room').value;
            
            if(selectedUser.isGuest) {
                myName = document.getElementById('customName').value;
                if(!myName) { showToast("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙŠØ§ Ø¶ÙŠÙ!"); return; }
            } else {
                myName = selectedUser.name;
            }

            if(!myRoom) { showToast("Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©!"); return; }

            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³ÙŠØ±ÙØ±
            socket.emit('join', { 
                username: myName, 
                room: myRoom, 
                userImg: selectedUser.img // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            });

            switchScreen('lobby');
            document.getElementById('rId').innerText = myRoom;
        }

        function start(){ socket.emit('start_game', {room: myRoom, category: document.getElementById('cat').value}); }
        function vote(){ 
            document.getElementById('revBtn').disabled = true; 
            document.getElementById('revBtn').innerText = "ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª...";
            socket.emit('request_reveal', {room: myRoom}); 
        }
        function shout(m){ socket.emit('send_shout', {room: myRoom, user: myName, msg: m}); }
        function reset(){ socket.emit('reset_game', {room: myRoom}); }

        // Socket Listeners
        socket.on('update_player_list', d => {
            document.getElementById('count').innerText = d.count;
            document.getElementById('pList').innerHTML = d.players.map(p => 
                `<div class="player-item">
                    <img src="${p.img}" class="player-img-sm">
                    <b style="font-size:14px;">${p.name}</b>
                 </div>`
            ).join('');
        });

        socket.on('game_started', d => {
            switchScreen('gameArea');
            const r = document.getElementById('role');
            const i = document.getElementById('item');
            
            if(d.is_spy) {
                r.innerText = "Ø£Ù†Øª Ø§Ù„Ø¨Ø±Øµ! ğŸ¦";
                r.style.color = "#ff4757";
                i.innerText = "ØŸØŸØŸØŸ";
                i.style.color = "#555";
                if(window.navigator.vibrate) window.navigator.vibrate([200,100,200]);
            } else {
                r.innerText = "Ø£Ù†Øª Ù…ÙˆØ§Ø·Ù† ğŸ‘®â€â™‚ï¸";
                r.style.color = "#2ecc71";
                i.innerText = d.item;
                i.style.color = "#ffd700";
            }
        });

        socket.on('vote_update', d => {
            document.getElementById('vStat').classList.remove('hidden');
            document.getElementById('vCount').innerText = `${d.current}/${d.total}`;
        });

        socket.on('receive_shout', d => {
            showToast(`${d.user}: ${d.msg}`);
        });

        socket.on('show_result', d => {
            switchScreen('resultArea');
            document.getElementById('spyName').innerText = d.spy;
            document.getElementById('pun').innerText = d.punishment;
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¯ÙŠÙ†Ø§
            let spyImage = "logo.png";
            const knownSpy = friends.find(f => f.name === d.spy);
            if(knownSpy) spyImage = knownSpy.img;
            
            // Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ØªÙŠ ÙŠØ±Ø³Ù„Ù‡Ø§ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¥Ù† ÙˆØ¬Ø¯Øª
            if(d.spyImg) spyImage = d.spyImg;

            document.getElementById('spyImg').src = spyImage;
        });

        socket.on('reset_view', () => {
            switchScreen('lobby');
            document.getElementById('revBtn').disabled = false;
            document.getElementById('revBtn').innerText = "ğŸš¨ ÙƒØ´Ù Ø§Ù„Ø¬Ø§Ø³ÙˆØ³";
            document.getElementById('vStat').classList.add('hidden');
        });

        function switchScreen(id) {
            ['loginArea', 'lobby', 'gameArea', 'resultArea'].forEach(i => document.getElementById(i).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }
    </script>
</body>
</html>
